<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK Service ‚Äì Formul√°≈ô (offline v7: adresa RK, CSV/XLS export, PDF)</title>
<style>
  :root{ --primary:#e6007e; --bg:#f7f7f9; --text:#111; --muted:#666; --border:#e5e7eb; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--text); }
  header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); z-index:10; }
  .wrap{ max-width:1200px; margin:0 auto; padding:12px 16px; }
  .brand{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .logo{ width:40px; height:40px; border-radius:12px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; overflow:hidden; background:#fff; }
  .logo img{ max-width:100%; max-height:100%; object-fit:contain; }
  .title{ font-weight:700; }
  .muted{ color:#666; font-size:12px; }
  .tabs{ display:flex; gap:8px; padding:8px 16px 12px; flex-wrap:wrap; }
  .tab{ padding:8px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; }
  .tab.active{ background:var(--primary); color:#fff; border-color:transparent; }
  main{ padding:16px; }
  .grid{ display:grid; gap:14px; }
  @media(min-width:900px){ .grid-2{ grid-template-columns: 1.6fr 1fr; } .grid-2-2{ grid-template-columns: 1fr 1fr; } .grid-3{ grid-template-columns: repeat(3, 1fr); } .grid-4{ grid-template-columns: repeat(4, 1fr); } }
  .card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:14px; }
  .contact-card{ border-left:4px solid var(--primary); }
  label .lbl{ display:block; font-size:13px; color:#444; margin:6px 0 4px; }
  .input, textarea, select{ width:100%; border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none; }
  .input:focus, textarea:focus, select:focus{ border-color:var(--primary); box-shadow:0 0 0 2px #e6007e33; }
  textarea{ min-height:110px; resize:vertical; }
  .btn{ padding:10px 14px; border:1px solid var(--border); border-radius:14px; background:#fff; cursor:pointer; }
  .btn.primary{ background:var(--primary); color:#fff; border-color:transparent; }
  .btn.danger{ color:#b91c1c; }
  .btn.sm{ padding:6px 10px; font-size:12px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; }
  .tag{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#f3f4f6; border:1px solid var(--border); }
  .table{ width:100%; border-collapse:collapse; }
  .table th, .table td{ padding:8px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; vertical-align:top; }
  .hidden{ display:none !important; }
  .watermark{ position:fixed; inset:0; pointer-events:none; opacity:.04; font-size:18vw; font-weight:900; display:flex; align-items:center; justify-content:center; color:#000; }
  .help{ font-size:12px; color:#666; }
  .actions .btn{ padding:6px 10px; font-size:12px; }
  .hint{ font-size:12px; color:#6b7280; }
  .section-title{ margin:0 0 6px; font-weight:600; }
  .kpi{ display:flex; gap:16px; align-items:center; font-size:12px; color:#444; }
  .kpi b{ font-size:14px; }
  @media print{
    header, .tabs { display:none !important; }
    body { background:#fff; }
    .card { border:none; padding:0; }
    .printable { display:block !important; }
  }
</style>
</head>
<body>
<div class="watermark">RK SERVICE</div>
<header>
  <div class="wrap brand">
    <div class="row" style="align-items:center">
      <div class="logo" id="logoBox">RK</div>
      <div>
        <div class="title" id="brandName">RK Service s.r.o.</div>
        <div class="muted" id="brandLine">777 200 905 ¬∑ info@rk-service.cz</div>
      </div>
    </div>
    <div class="card contact-card">
      <div style="font-weight:600">Kontakt RK Service</div>
      <div id="brandAddr">Osvobozen√≠ 60, Luka nad Jihlavou</div>
      <div id="brandIco">IƒåO 10709681</div>
      <div class="muted" id="brandWeb">rk-service.cz</div>
    </div>
  </div>
  <div class="tabs wrap">
    <button class="tab active" data-tab="new">Nov√Ω z√°znam</button>
    <button class="tab" data-tab="list">Z√°znamy</button>
    <button class="tab" data-tab="customers">Z√°kazn√≠ci</button>
    <button class="tab" data-tab="settings">Nastaven√≠</button>
  </div>
</header>

<main class="wrap">
  <!-- NEW -->
  <section id="tab-new">
    <div class="grid grid-2">
      <div class="card">
        <h3>Z√°kladn√≠ informace</h3>
        <div class="grid grid-2-2">
          <label><div class="lbl">Datum a ƒças jedn√°n√≠</div><input class="input" type="datetime-local" id="meetingDate"></label>
          <label><div class="lbl">Typ z√°znamu</div><select class="input" id="recordType">
            <option>Jedn√°n√≠</option><option>Lead</option><option>Po≈æadavek</option><option>Oprava</option><option>Reklamace</option><option>Jin√©</option>
          </select></label>

          <label><div class="lbl">IƒåO</div>
            <div class="row"><input class="input" id="ico" placeholder="Nap≈ô. 10709681" style="flex:1">
              <select class="input" id="icoCountry" style="width:120px">
                <option value="CZ">CZ</option>
                <option value="SK">SK</option>
              </select>
              <button class="btn sm" id="icoLookup">Naƒç√≠st z registru</button>
            </div>
            <div class="hint">Funguje pro ƒçesk√© (ARES) a slovensk√© (RegisterUZ) subjekty. Pokud prohl√≠≈æeƒç blokuje CORS, √∫daje pros√≠m dopl≈àte ruƒçnƒõ.</div>
          </label>
          <label><div class="lbl">DIƒå / VAT</div><input class="input" id="dic" placeholder="CZ12345678 / SK1234567890"></label>

          <label><div class="lbl">Spoleƒçnost</div><input class="input" id="company" placeholder="Firma s.r.o."></label>
          <label><div class="lbl">Kontakt ‚Äì jm√©no</div><input class="input" id="contactName" placeholder="Jm√©no a p≈ô√≠jmen√≠"></label>
          <label><div class="lbl">Telefon</div><input class="input" id="phone" inputmode="tel" placeholder="+420..."></label>
          <label><div class="lbl">E‚Äëmail</div><input class="input" id="email" inputmode="email" placeholder="email@firma.cz"></label>
          <label><div class="lbl">M√≠sto (jedn√°n√≠)</div><input class="input" id="location" placeholder="Adresa, mƒõsto"></label>
          <label><div class="lbl">Dodac√≠ adresa</div><input class="input" id="deliveryAddress" placeholder="Ulice, ƒç.p., PSƒå, mƒõsto"></label>
          <label><div class="lbl">Fakturaƒçn√≠ adresa</div><input class="input" id="billingAddress" placeholder="Ulice, ƒç.p., PSƒå, mƒõsto"></label>

          <label class="grid-span"><div class="lbl">T√©ma / N√°zev p≈ô√≠le≈æitosti <button class="btn sm" id="micTopic">üé§ Diktovat</button> <button class="btn sm hidden" id="stopTopic">‚ñ† Stop</button></div>
            <input class="input" id="topic" placeholder="Nap≈ô. Filtrace hydrauliky linky X"></label>
        </div>
        <label><div class="lbl">Pozn√°mky z jedn√°n√≠ <button class="btn sm" id="micNotes">üé§ Diktovat</button> <button class="btn sm hidden" id="stopNotes">‚ñ† Stop</button></div>
          <textarea id="notes" placeholder="Shrnut√≠, kl√≠ƒçov√© body, citace..."></textarea></label>
        <label><div class="lbl">√ökoly / Dal≈°√≠ kroky</div><textarea id="actionItems" placeholder="Co, kdo, do kdy"></textarea></label>
        <div class="grid grid-3">
          <label><div class="lbl">Term√≠n dal≈°√≠ho kroku</div><input class="input" type="date" id="nextStepDate"></label>
          <label><div class="lbl">Stav</div><select class="input" id="status"><option>Nov√©</option><option>V ≈ôe≈°en√≠</option><option>Hotovo</option><option>Pozastaveno</option></select></label>
          <label><div class="lbl">Priorita</div><select class="input" id="priority"><option>N√≠zk√°</option><option selected>St≈ôedn√≠</option><option>Vysok√°</option></select></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="saveBtn">Ulo≈æit z√°znam</button>
          <button class="btn" id="newBtn">Nov√Ω</button>
          <button class="btn" id="shareBtn">Sd√≠let z√°pis</button>
          <button class="btn" id="mailBtn">Odeslat e‚Äëmailem</button>
          <button class="btn" id="printBtn">PDF (tisk z√°znamu)</button>
        </div>
      </div>

      <div class="card">
        <h3>P≈ô√≠lohy & dopl≈àky</h3>
        <div>
          <div class="lbl">Fotografie (kamera)</div>
          <input type="file" accept="image/*" id="photoInput" capture="environment" />
          <div id="photoPreview"></div>
        </div>
        <div style="margin-top:12px">
          <div class="lbl">Podpis z√°kazn√≠ka</div>
          <canvas id="sig" width="900" height="240" style="width:100%;height:160px;border:1px solid var(--border);border-radius:12px;background:#fafafa"></canvas>
          <div class="row" style="margin-top:6px">
            <button class="btn" id="sigClear">Vymazat</button>
            <button class="btn" id="sigSave">Ulo≈æit podpis</button>
          </div>
          <div id="sigPreview" style="margin-top:6px"></div>
        </div>
        <div style="margin-top:12px">
          <div class="lbl">Geolokace</div>
          <div class="row">
            <input class="input" id="geo" placeholder="lat,lon" style="flex:1">
            <button class="btn" id="geoBtn">Z√≠skat</button>
          </div>
          <div class="help">Pozn.: hlasov√Ω dikt√°t funguje jen v prohl√≠≈æeƒç√≠ch, kter√© podporuj√≠ Web Speech API.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section id="tab-list" class="hidden">
    <div class="card">
      <div class="row">
        <input class="input" id="search" placeholder="Hledat firmu, kontakt, t√©ma, pozn√°mky‚Ä¶" style="flex:1">
        <select class="input" id="fType"><option value="all">Typ: v≈°e</option><option>Jedn√°n√≠</option><option>Lead</option><option>Po≈æadavek</option><option>Oprava</option><option>Reklamace</option><option>Jin√©</option></select>
        <select class="input" id="fStatus"><option value="all">Stav: v≈°e</option><option>Nov√©</option><option>V ≈ôe≈°en√≠</option><option>Hotovo</option><option>Pozastaveno</option></select>
        <select class="input" id="fPriority"><option value="all">Priorita: v≈°e</option><option>N√≠zk√°</option><option>St≈ôedn√≠</option><option>Vysok√°</option></select>
        <button class="btn" id="printAll">PDF (tisk seznamu)</button>
      </div>
      <div id="listWrap" style="margin-top:10px"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="exportRecordsCSV">Exportovat z√°znamy (CSV)</button>
        <button class="btn" id="exportRecordsXLS">Exportovat z√°znamy (XLS)</button>
      </div>
    </div>
  </section>

  <!-- CUSTOMERS -->
  <section id="tab-customers" class="hidden">
    <div class="card">
      <h3>Z√°kazn√≠ci</h3>

      <div class="grid grid-4" style="margin:8px 0 12px">
        <label><div class="lbl">IƒåO</div><input class="input" id="cIco" placeholder="Nap≈ô. 12345678"></label>
        <label><div class="lbl">DIƒå / VAT</div><input class="input" id="cDic" placeholder="CZ..., SK..."></label>
        <label><div class="lbl">St√°t</div>
          <select class="input" id="cCountry"><option value="CZ">CZ</option><option value="SK">SK</option></select>
        </label>
        <label><div class="lbl">&nbsp;</div><button class="btn sm" id="cLookup">Naƒç√≠st z registru</button></label>

        <label class="grid-span"><div class="lbl">Spoleƒçnost</div><input class="input" id="cCompany" placeholder="Firma s.r.o."></label>
        <label class="grid-span"><div class="lbl">Adresa (ulo≈æ√≠ se k z√°kazn√≠kovi)</div><input class="input" id="cAddress" placeholder="Ulice, ƒç.p., PSƒå, mƒõsto"></label>
        <label><div class="lbl">Kontakt ‚Äì jm√©no</div><input class="input" id="cName" placeholder="Jm√©no a p≈ô√≠jmen√≠"></label>
        <label><div class="lbl">Telefon</div><input class="input" id="cPhone" inputmode="tel" placeholder="+420..."></label>
        <label><div class="lbl">E‚Äëmail</div><input class="input" id="cEmail" inputmode="email" placeholder="email@firma.cz"></label>
        <label class="grid-span"><div class="lbl">Pozn√°mka</div><input class="input" id="cNote" placeholder="nap≈ô. filtrace hydrauliky linky X"></label>
      </div>
      <div class="row" style="margin-bottom:8px">
        <button class="btn primary" id="cAdd">P≈ôidat z√°kazn√≠ka</button>
        <div class="help">P≈ôid√° z√°znam do seznamu z√°kazn√≠k≈Ø bez vypl≈àov√°n√≠ formul√°≈ôe jedn√°n√≠.</div>
      </div>

      <table class="table" id="custTable">
        <thead><tr><th>IƒåO</th><th>DIƒå</th><th>Spoleƒçnost</th><th>Adresa</th><th>Kontakt</th><th>Telefon</th><th>E‚Äëmail</th><th>Pozn√°mka</th><th class="actions">Akce</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="exportCustomersCSV">Exportovat z√°kazn√≠ky (CSV)</button>
        <button class="btn" id="exportCustomersXLS">Exportovat z√°kazn√≠ky (XLS)</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="hidden">
    <div class="card">
      <h3>Nastaven√≠ ‚Äì branding a kontakty</h3>
      <div class="grid grid-2-2">
        <label><div class="lbl">N√°zev firmy</div><input class="input" id="bCompany" value="RK Service s.r.o."></label>
        <label><div class="lbl">Adresa</div><input class="input" id="bAddress" value="Osvobozen√≠ 60, Luka nad Jihlavou"></label>
        <label><div class="lbl">IƒåO</div><input class="input" id="bIco" value="IƒåO 10709681"></label>
        <label><div class="lbl">Telefon</div><input class="input" id="bPhone" value="777 200 905"></label>
        <label><div class="lbl">E‚Äëmail</div><input class="input" id="bEmail" value="info@rk-service.cz"></label>
        <label><div class="lbl">Web</div><input class="input" id="bWeb" value="https://rk-service.cz"></label>
        <label><div class="lbl">Prim√°rn√≠ barva</div><input class="input" id="bColor" type="color" value="#e6007e"></label>
        <div>
          <div class="lbl">Logo (PNG/SVG)</div>
          <input type="file" id="bLogo" accept="image/*">
          <div id="logoPreview" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Nastaven√≠ ‚Äì import/export & chov√°n√≠ adresy</h3>
      <div class="grid grid-2-2">
        <label><div class="lbl">P≈ôi naƒçten√≠ z registru vyplnit adresu jako</div>
          <select class="input" id="bPrefAddressTarget">
            <option value="delivery">Dodac√≠ adresa</option>
            <option value="billing">Fakturaƒçn√≠ adresa</option>
            <option value="both">Obƒõ (dodac√≠ i fakturaƒçn√≠)</option>
          </select>
        </label>
      </div>

      <div class="section-title">Export</div>
      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="exportRecords">Exportovat z√°znamy (CSV)</button>
        <button class="btn" id="exportCustomers">Exportovat z√°kazn√≠ky (CSV)</button>
      </div>

      <div class="section-title">Import (CSV)</div>
      <div class="help">Oƒçek√°van√© hlaviƒçky: pro z√°znamy <code>id,createdAt,meetingDate,ico,dic,company,contactName,phone,email,location,billingAddress,deliveryAddress,recordType,topic,notes,actionItems,nextStepDate,status,priority,geo</code>. Pro z√°kazn√≠ky <code>id,ico,dic,company,address,contactName,phone,email,note</code>.</div>
      <div class="row">
        <input type="file" id="importRecordsFile" accept=".csv">
        <button class="btn" id="importRecords">Importovat z√°znamy</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input type="file" id="importCustomersFile" accept=".csv">
        <button class="btn" id="importCustomers">Importovat z√°kazn√≠ky</button>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="saveBrand">Ulo≈æit nastaven√≠</button>
        <button class="btn" id="resetBrand">Obnovit v√Ωchoz√≠</button>
        <button class="btn danger" id="wipeAll">Smazat v≈°echna data</button>
      </div>
      <div class="help">Nastaven√≠ a data se ukl√°daj√≠ pouze do tohoto za≈ô√≠zen√≠ (localStorage).</div>
    </div>
  </section>
</main>

<script>
// --- Helpers ---
const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const load = (k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } };
const uid = ()=> Date.now() + "_" + Math.random().toString(36).slice(2,8);
const fmt = (iso)=> iso? new Date(iso).toLocaleString(): "";

function csvEscape(v){ if(v==null) v=''; v=String(v); if(/[",\n]/.test(v)){ return '"' + v.replace(/"/g,'""') + '"'; } return v; }
function toCSV(rows){ return rows.map(r=> r.map(csvEscape).join(',')).join('\n'); }
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const ch=text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      } else { field+=ch; i++; continue; }
    } else {
      if(ch === '"'){ inQ=true; i++; continue; }
      if(ch === ','){ row.push(field); field=''; i++; continue; }
      if(ch === '\n' || ch === '\r'){ if(ch=='\r' && text[i+1]=='\n') i++; row.push(field); rows.push(row); field=''; row=[]; i++; continue; }
      field+=ch; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  return rows.filter(r=> r.length>1 || (r.length===1 && r[0].trim()!==''));
}

// --- State ---
let brand = load('rks_brand', { company:'RK Service s.r.o.', address:'Osvobozen√≠ 60, Luka nad Jihlavou', ico:'IƒåO 10709681', phone:'777 200 905', email:'info@rk-service.cz', web:'https://rk-service.cz', color:'#e6007e', logo:'', prefAddressTarget:'delivery' });
let records = load('rks_records', []);
let customers = load('rks_customers', []);

// --- Brand apply ---
function applyBrand(){
  document.documentElement.style.setProperty('--primary', brand.color||'#e6007e');
  document.getElementById('brandName').textContent = brand.company || 'RK Service s.r.o.';
  document.getElementById('brandLine').textContent = (brand.phone||'') + ' ¬∑ ' + (brand.email||'');
  document.getElementById('brandAddr').textContent = brand.address || 'Osvobozen√≠ 60, Luka nad Jihlavou';
  document.getElementById('brandIco').textContent = brand.ico || '';
  document.getElementById('brandWeb').textContent = (brand.web||'').replace(/^https?:\/\//,'');
  const box = document.getElementById('logoBox'); box.innerHTML='';
  if(brand.logo){ const img=new Image(); img.src=brand.logo; box.appendChild(img); } else { box.textContent='RK'; }
}
applyBrand();

// --- Tabs ---
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
    if(t==='list') renderList();
    if(t==='customers') renderCustomers();
    if(t==='settings') loadSettings();
  });
});

// --- Defaults ---
const nowLocal = ()=>{ const d = new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); };
document.getElementById('meetingDate').value = nowLocal();
document.getElementById('status').value = 'Nov√©';
document.getElementById('priority').value='St≈ôedn√≠';

// --- Photo ---
document.getElementById('photoInput').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas');
      const maxW = 1200, scale = Math.min(1, maxW/img.width);
      c.width = Math.round(img.width*scale); c.height = Math.round(img.height*scale);
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
      const data = c.toDataURL('image/jpeg', 0.8);
      document.getElementById('photoPreview').innerHTML = '<img src="'+data+'" style="max-height:220px;width:100%;object-fit:contain;border:1px solid #e5e7eb;border-radius:12px;margin-top:6px">';
      document.getElementById('photoPreview').dataset.data = data;
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
});

// --- Signature ---
const sig = document.getElementById('sig'); const ctx = sig.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round';
let drawing=false;
function pos(e){ const r=sig.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
sig.addEventListener('mousedown', (e)=>{ const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); drawing=true; });
sig.addEventListener('mousemove', (e)=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
['mouseup','mouseleave'].forEach(ev=>sig.addEventListener(ev, ()=>drawing=false));
sig.addEventListener('touchstart', (e)=>{ const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); drawing=true; });
sig.addEventListener('touchmove', (e)=>{ const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
sig.addEventListener('touchend', ()=>drawing=false);
document.getElementById('sigClear').onclick = ()=>{ ctx.clearRect(0,0,sig.width,sig.height); document.getElementById('sigPreview').innerHTML=''; document.getElementById('sigPreview').dataset.data=''; };
document.getElementById('sigSave').onclick = ()=>{
  const data = sig.toDataURL('image/png');
  document.getElementById('sigPreview').innerHTML = '<img src="'+data+'" style="max-height:120px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">';
  document.getElementById('sigPreview').dataset.data = data;
};

// --- Geo ---
document.getElementById('geoBtn').onclick = ()=>{
  if(!navigator.geolocation) return alert('Geolokace nen√≠ podporov√°na');
  navigator.geolocation.getCurrentPosition(
    (p)=>{ const v=p.coords.latitude.toFixed(6)+','+p.coords.longitude.toFixed(6); document.getElementById('geo').value=v; },
    (e)=>alert('Nelze z√≠skat polohu: '+e.message),
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
};

// --- Dictation ---
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
function startDict(targetId, startBtn, stopBtn){
  if(!SR){ alert('Hlasov√Ω dikt√°t nen√≠ v tomto prohl√≠≈æeƒçi dostupn√Ω.'); return; }
  const rec = new SR(); rec.lang='cs-CZ'; rec.interimResults=true; rec.continuous=true;
  rec.onresult = (e)=>{
    for(let i=e.resultIndex;i<e.results.length;i++){ const res=e.results[i]; if(res.isFinal){ const t=res[0].transcript.trim(); if(!t) continue;
      const el = document.getElementById(targetId);
      if(targetId==='topic') el.value = (el.value? el.value+' ' : '') + t;
      else el.value = (el.value? el.value+'\\n' : '') + t;
    }}
  };
  rec.onend = ()=>{ stopBtn.classList.add('hidden'); startBtn.classList.remove('hidden'); };
  rec.onerror = ()=>{};
  rec.start();
  stopBtn.onclick = ()=> rec.stop();
  startBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
}
document.getElementById('micTopic').onclick = ()=> startDict('topic', document.getElementById('micTopic'), document.getElementById('stopTopic'));
document.getElementById('micNotes').onclick = ()=> startDict('notes', document.getElementById('micNotes'), document.getElementById('stopNotes'));

// --- Save / New ---
function getFormData(){
  return {
    id: document.getElementById('recordId')?.value || '',
    createdAt: new Date().toISOString(),
    meetingDate: document.getElementById('meetingDate').value,
    ico: document.getElementById('ico').value.trim(),
    dic: document.getElementById('dic').value.trim(),
    company: document.getElementById('company').value.trim(),
    contactName: document.getElementById('contactName').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    location: document.getElementById('location').value.trim(),
    billingAddress: document.getElementById('billingAddress').value.trim(),
    deliveryAddress: document.getElementById('deliveryAddress').value.trim(),
    recordType: document.getElementById('recordType').value,
    topic: document.getElementById('topic').value,
    notes: document.getElementById('notes').value,
    actionItems: document.getElementById('actionItems').value,
    nextStepDate: document.getElementById('nextStepDate').value,
    status: document.getElementById('status').value,
    priority: document.getElementById('priority').value,
    assigned: '', geo: document.getElementById('geo').value,
    photo: document.getElementById('photoPreview').dataset.data || '',
    signature: document.getElementById('sigPreview').dataset.data || '',
    gdprConsent: true
  };
}
function setFormData(r){
  const nowL = nowLocal();
  document.getElementById('meetingDate').value = r.meetingDate || nowL;
  document.getElementById('ico').value = r.ico || '';
  document.getElementById('dic').value = r.dic || '';
  document.getElementById('company').value = r.company || '';
  document.getElementById('contactName').value = r.contactName || '';
  document.getElementById('phone').value = r.phone || '';
  document.getElementById('email').value = r.email || '';
  document.getElementById('location').value = r.location || '';
  document.getElementById('billingAddress').value = r.billingAddress || '';
  document.getElementById('deliveryAddress').value = r.deliveryAddress || '';
  document.getElementById('recordType').value = r.recordType || 'Jedn√°n√≠';
  document.getElementById('topic').value = r.topic || '';
  document.getElementById('notes').value = r.notes || '';
  document.getElementById('actionItems').value = r.actionItems || '';
  document.getElementById('nextStepDate').value = r.nextStepDate || '';
  document.getElementById('status').value = r.status || 'Nov√©';
  document.getElementById('priority').value = r.priority || 'St≈ôedn√≠';
  document.getElementById('geo').value = r.geo || '';
  document.getElementById('photoPreview').innerHTML = r.photo? '<img src="'+r.photo+'" style="max-height:220px;width:100%;object-fit:contain;border:1px solid #e5e7eb;border-radius:12px;margin-top:6px">' : '';
  document.getElementById('photoPreview').dataset.data = r.photo || '';
  document.getElementById('sigPreview').innerHTML = r.signature? '<img src="'+r.signature+'" style="max-height:120px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">': '';
  document.getElementById('sigPreview').dataset.data = r.signature || '';
}
document.getElementById('newBtn').onclick = ()=>{ setFormData({}); };
document.getElementById('saveBtn').onclick = ()=>{
  const r = getFormData(); r.id = r.id || uid();
  const idx = records.findIndex(x=>x.id===r.id);
  if(idx>=0) records[idx]=r; else records.unshift(r);
  save('rks_records', records);
  if(r.company){
    const exists = customers.some(c=> (c.company||'').trim().toLowerCase() === r.company.trim().toLowerCase());
    if(!exists){
      customers.unshift({ id:uid(), ico:r.ico||'', dic:r.dic||'', company:r.company, address:r.deliveryAddress||r.billingAddress||'', contactName:r.contactName, phone:r.phone, email:r.email, note:r.topic });
      save('rks_customers', customers);
    }
  }
  alert('Ulo≈æeno.');
  setFormData({});
};

// --- List rendering ---
function renderList(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  const tf = document.getElementById('fType').value;
  const sf = document.getElementById('fStatus').value;
  const pf = document.getElementById('fPriority').value;
  const ok = (r)=>{
    const mq = !q || [r.company,r.contactName,r.phone,r.email,r.topic,r.notes,r.location,r.deliveryAddress,r.billingAddress,r.recordType,r.status,r.priority,r.ico,r.dic].some(v=> (v||'').toLowerCase().includes(q));
    const mt = tf==='all' || r.recordType===tf;
    const ms = sf==='all' || r.status===sf;
    const mp = pf==='all' || r.priority===pf;
    return mq && mt && ms && mp;
  };
  const wrap = document.getElementById('listWrap'); wrap.innerHTML='';
  records.filter(ok).forEach(r=>{
    const el = document.createElement('div'); el.className='card'; el.style.marginBottom='10px';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><strong>${r.company||'(bez spoleƒçnosti)'}</strong> ‚Äî <span class="muted">${r.recordType}</span></div>
        <div class="muted">${fmt(r.meetingDate||r.createdAt)}</div>
      </div>
      <div class="muted" style="margin:4px 0">${r.topic||''}</div>
      <div class="row" style="flex-wrap:wrap;gap:10px;margin:6px 0">
        <div><b>IƒåO:</b> ${r.ico||'‚Äî'}</div>
        <div><b>DIƒå:</b> ${r.dic||'‚Äî'}</div>
        <div><b>Kontakt:</b> ${r.contactName||'‚Äî'}</div>
        <div><b>Tel:</b> ${r.phone||'‚Äî'}</div>
        <div><b>E‚Äëmail:</b> ${r.email||'‚Äî'}</div>
        <div><b>M√≠sto:</b> ${r.location||'‚Äî'}</div>
        <div><b>Dodac√≠ adresa:</b> ${r.deliveryAddress||'‚Äî'}</div>
        <div><b>Fakturaƒçn√≠ adresa:</b> ${r.billingAddress||'‚Äî'}</div>
      </div>
      <details>
        <summary>Pozn√°mky / √∫koly</summary>
        <div class="grid grid-2-2" style="margin-top:6px">
          <div><div class="muted">Pozn√°mky</div><div style="white-space:pre-wrap">${r.notes||'‚Äî'}</div></div>
          <div><div class="muted">√ökoly / Dal≈°√≠ kroky</div><div style="white-space:pre-wrap">${r.actionItems||'‚Äî'}</div></div>
        </div>
      </details>
      <div class="row" style="margin-top:8px">
        <span class="tag">${r.status}</span>
        <span class="tag">Priorita: ${r.priority}</span>
        ${r.nextStepDate? `<span class="tag">Dal≈°√≠ krok: ${new Date(r.nextStepDate).toLocaleDateString()}</span>`:''}
        ${r.geo? `<span class="tag">GPS: ${r.geo}</span>`:''}
      </div>
      <div class="row" style="margin-top:8px">
        ${r.photo? `<img src="${r.photo}" style="height:70px;border:1px solid #e5e7eb;border-radius:10px">`:''}
        ${r.signature? `<img src="${r.signature}" style="height:70px;border:1px solid #e5e7eb;border-radius:10px;background:#fff">`:''}
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" data-act="edit">Upravit</button>
        <button class="btn danger" data-act="del">Smazat</button>
        <button class="btn" data-act="email">Poslat e‚Äëmail</button>
        <button class="btn" data-act="share">Sd√≠let</button>
      </div>
    `;
    el.querySelector('[data-act="edit"]').onclick = ()=>{ setFormData(r); document.querySelector('[data-tab="new"]').click(); };
    el.querySelector('[data-act="del"]').onclick = ()=>{ if(!confirm('Opravdu smazat?')) return; records = records.filter(x=>x.id!==r.id); save('rks_records', records); renderList(); };
    el.querySelector('[data-act="email"]').onclick = ()=> sendEmail(r);
    el.querySelector('[data-act="share"]').onclick = ()=> shareRecord(r);
    wrap.appendChild(el);
  });
  if(!wrap.innerHTML) wrap.innerHTML = '<div class="muted" style="padding:20px;text-align:center">≈Ω√°dn√© z√°znamy neodpov√≠daj√≠ filtru.</div>';
}
['search','fType','fStatus','fPriority'].forEach(id=> document.getElementById(id).addEventListener('input', renderList));

// --- Customers ---
function renderCustomers(){
  const tb = document.querySelector('#custTable tbody'); tb.innerHTML='';
  customers.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.ico||''}</td><td>${c.dic||''}</td><td>${c.company}</td><td>${c.address||'‚Äî'}</td><td>${c.contactName||'‚Äî'}</td><td>${c.phone||'‚Äî'}</td><td>${c.email||'‚Äî'}</td><td>${c.note||'‚Äî'}</td>
    <td class="actions">
      <button class="btn sm" data-act="edit">Upravit</button>
      <button class="btn sm danger" data-act="del">Smazat</button>
    </td>`;
    tr.querySelector('[data-act="edit"]').onclick = ()=>{
      document.getElementById('cIco').value = c.ico||'';
      document.getElementById('cDic').value = c.dic||'';
      document.getElementById('cCountry').value = (c.dic||'').startsWith('SK')? 'SK' : 'CZ';
      document.getElementById('cCompany').value = c.company||'';
      document.getElementById('cAddress').value = c.address||'';
      document.getElementById('cName').value = c.contactName||'';
      document.getElementById('cPhone').value = c.phone||'';
      document.getElementById('cEmail').value = c.email||'';
      document.getElementById('cNote').value = c.note||'';
      customers = customers.filter(x=>x.id!==c.id);
      save('rks_customers', customers);
      renderCustomers();
    };
    tr.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm('Opravdu smazat z√°kazn√≠ka?')) return;
      customers = customers.filter(x=>x.id!==c.id);
      save('rks_customers', customers);
      renderCustomers();
    };
    tb.appendChild(tr);
  });
  if(!customers.length){
    const tr=document.createElement('tr'); tr.innerHTML='<td colspan="9" class="muted">Zat√≠m ≈æ√°dn√≠ z√°kazn√≠ci.</td>'; tb.appendChild(tr);
  }
}

// Add customer quick form
document.getElementById('cAdd').onclick = ()=>{
  const company = document.getElementById('cCompany').value.trim();
  const address = document.getElementById('cAddress').value.trim();
  const contactName = document.getElementById('cName').value.trim();
  const phone = document.getElementById('cPhone').value.trim();
  const email = document.getElementById('cEmail').value.trim();
  const note = document.getElementById('cNote').value.trim();
  const ico = document.getElementById('cIco').value.trim();
  const dic = document.getElementById('cDic').value.trim();
  if(!company){ alert('Vypl≈àte pros√≠m n√°zev spoleƒçnosti.'); return; }
  const exists = customers.some(c=> (c.company||'').toLowerCase() === company.toLowerCase());
  if(exists){ alert('Z√°kazn√≠k se stejn√Ωm n√°zvem u≈æ existuje.'); return; }
  customers.unshift({ id: uid(), ico, dic, company, address, contactName, phone, email, note });
  save('rks_customers', customers);
  ['cIco','cDic','cCompany','cAddress','cName','cPhone','cEmail','cNote'].forEach(id=> document.getElementById(id).value = '');
  renderCustomers();
};

// --- Settings load/save ---
function loadSettings(){
  document.getElementById('bCompany').value = brand.company||'';
  document.getElementById('bAddress').value = brand.address||'';
  document.getElementById('bIco').value = brand.ico||'';
  document.getElementById('bPhone').value = brand.phone||'';
  document.getElementById('bEmail').value = brand.email||'';
  document.getElementById('bWeb').value = brand.web||'';
  document.getElementById('bColor').value = brand.color||'#e6007e';
  document.getElementById('bPrefAddressTarget').value = brand.prefAddressTarget || 'delivery';
  const prev = document.getElementById('logoPreview'); prev.innerHTML = brand.logo? '<img src="'+brand.logo+'" style="max-height:70px">' : '';
}
document.getElementById('bLogo').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const rd = new FileReader(); rd.onload = ()=>{ brand.logo = rd.result; document.getElementById('logoPreview').innerHTML = '<img src="'+brand.logo+'" style="max-height:70px">'; applyBrand(); save('rks_brand', brand); };
  rd.readAsDataURL(f);
});
document.getElementById('saveBrand').onclick = ()=>{
  brand = {
    company: document.getElementById('bCompany').value,
    address: document.getElementById('bAddress').value,
    ico: document.getElementById('bIco').value,
    phone: document.getElementById('bPhone').value,
    email: document.getElementById('bEmail').value,
    web: document.getElementById('bWeb').value,
    color: document.getElementById('bColor').value,
    logo: brand.logo||'',
    prefAddressTarget: document.getElementById('bPrefAddressTarget').value || 'delivery'
  };
  save('rks_brand', brand); applyBrand(); alert('Ulo≈æeno.');
};
document.getElementById('resetBrand').onclick = ()=>{
  localStorage.removeItem('rks_brand');
  brand = { company:'RK Service s.r.o.', address:'Osvobozen√≠ 60, Luka nad Jihlavou', ico:'IƒåO 10709681', phone:'777 200 905', email:'info@rk-service.cz', web:'https://rk-service.cz', color:'#e6007e', logo:'', prefAddressTarget:'delivery' };
  applyBrand(); loadSettings(); alert('Obnoveno.');
};
document.getElementById('wipeAll').onclick = ()=>{
  if(!confirm('Smazat V≈†ECHNA data (z√°znamy + z√°kazn√≠ci + nastaven√≠)?')) return;
  localStorage.removeItem('rks_records'); localStorage.removeItem('rks_customers'); localStorage.removeItem('rks_brand');
  records=[]; customers=[]; alert('Smaz√°no.');
};

// --- Email + Share ---
function buildEmailBody(r){
  const arr = [
    `Dobr√Ω den ${r.contactName||''},`,'',
    'zas√≠l√°me V√°m z√°pis z jedn√°n√≠:','',
    `IƒåO: ${r.ico||'-'}`,
    `DIƒå: ${r.dic||'-'}`,
    `Spoleƒçnost: ${r.company||'-'}`,
    `Kontakt: ${r.contactName||'-'} | Tel: ${r.phone||'-'} | E‚Äëmail: ${r.email||'-'}`,
    `Datum jedn√°n√≠: ${fmt(r.meetingDate)}`,
    `M√≠sto: ${r.location||'-'}`,
    `Dodac√≠ adresa: ${r.deliveryAddress||'-'}`,
    `Fakturaƒçn√≠ adresa: ${r.billingAddress||'-'}`,
    `Typ z√°znamu: ${r.recordType}`,
    `T√©ma: ${r.topic||'-'}`,'',
    'Pozn√°mky:', (r.notes||'-'), '',
    '√ökoly / Dal≈°√≠ kroky:', (r.actionItems||'-'), '',
    (r.nextStepDate? 'Dal≈°√≠ krok do: '+new Date(r.nextStepDate).toLocaleDateString() : ''),
    (r.geo? 'GPS: '+r.geo : ''),'',
    '‚Äî',
    brand.company, brand.address, brand.ico,
    `Tel: ${brand.phone} | E‚Äëmail: ${brand.email}`, (brand.web||'').replace(/^https?:\/\//,'')
  ].filter(Boolean);
  return arr.join('\n');
}
function sendEmail(r){
  const subject = encodeURIComponent(`Z√°pis z jedn√°n√≠ ‚Äì ${r.company||'bez n√°zvu'} (${new Date(r.meetingDate).toLocaleDateString()})`);
  const body = encodeURIComponent(buildEmailBody(r));
  const to = encodeURIComponent(r.email||'');
  const cc = encodeURIComponent(brand.email||'');
  location.href = `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;
}
async function shareRecord(r){
  const text = buildEmailBody(r);
  if(navigator.share){ try{ await navigator.share({ title:'Z√°pis z jedn√°n√≠', text }); }catch(e){} }
  else{ try{ await navigator.clipboard.writeText(text); alert('Z√°pis zkop√≠rov√°n do schr√°nky.'); }catch(e){ alert('Zkop√≠rov√°n√≠ se nepoda≈ôilo.'); } }
}
document.getElementById('mailBtn').onclick = ()=> sendEmail(getFormData());
document.getElementById('shareBtn').onclick = ()=> shareRecord(getFormData());

// --- IƒåO lookup (CZ/SK) ---
function normIco(v){ return (v||'').replace(/\D+/g,'').padStart(8,'0'); }
async function lookupCZ(ico){
  const url = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${ico}`;
  const r = await fetch(url, { headers: { 'Accept':'application/json' } });
  if(!r.ok) throw new Error('ARES ' + r.status);
  const j = await r.json();
  const name = j.obchodniJmeno || '';
  const address = (j.sidlo && (j.sidlo.textovaAdresa || [j.sidlo.nazevUlice, j.sidlo.cisloDomovni, j.sidlo.cisloOrientacni, j.sidlo.psc, j.sidlo.nazevObce].filter(Boolean).join(' '))) || '';
  const dic = j.dphId || (j.dic || '');
  return { name, address, dic };
}
async function lookupSK(ico){
  const url = `https://www.registeruz.sk/cruz-public/api/uctovna-jednotka?ico=${ico}`;
  const r = await fetch(url, { headers: { 'Accept':'application/json' } });
  if(!r.ok) throw new Error('RegisterUZ ' + r.status);
  const j = await r.json();
  if(!Array.isArray(j) || !j.length) throw new Error('Nenalezeno');
  const item = j[0];
  const name = item.nazovUJ || '';
  const address = [item.ulica, item.cisloDom, item.psc, item.obec].filter(Boolean).join(' ');
  const dic = item.dic || '';
  return { name, address, dic };
}
async function doIcoLookup(czsk, ico, fillTargets){
  try{
    const nico = normIco(ico);
    if(!nico){ alert('Zadejte IƒåO.'); return; }
    const res = czsk==='CZ' ? await lookupCZ(nico) : await lookupSK(nico);
    if(res.name && fillTargets.company) document.getElementById(fillTargets.company).value = res.name;
    if(res.address){
      const pref = brand.prefAddressTarget || 'delivery';
      if(fillTargets.deliveryAddress && (pref==='delivery' || pref==='both')) document.getElementById(fillTargets.deliveryAddress).value = res.address;
      if(fillTargets.billingAddress && (pref==='billing' || pref==='both')) document.getElementById(fillTargets.billingAddress).value = res.address;
      if(fillTargets.customerAddress) document.getElementById(fillTargets.customerAddress).value = res.address;
    }
    if(res.dic && fillTargets.dic) document.getElementById(fillTargets.dic).value = res.dic;
    if(fillTargets.icoField) document.getElementById(fillTargets.icoField).value = nico;
    alert('√ödaje naƒçteny z registru.');
  }catch(e){
    console.error(e);
    alert('Nepoda≈ôilo se naƒç√≠st √∫daje z registru ('+ e.message +'). M≈Ø≈æete vyplnit ruƒçnƒõ.');
  }
}
document.getElementById('icoLookup').onclick = ()=>{
  const czsk = document.getElementById('icoCountry').value;
  const ico = document.getElementById('ico').value;
  doIcoLookup(czsk, ico, { company:'company', deliveryAddress:'deliveryAddress', billingAddress:'billingAddress', dic:'dic', icoField:'ico' });
};
document.getElementById('cLookup').onclick = ()=>{
  const czsk = document.getElementById('cCountry').value;
  const ico = document.getElementById('cIco').value;
  doIcoLookup(czsk, ico, { company:'cCompany', customerAddress:'cAddress', dic:'cDic', icoField:'cIco' });
};

// --- Exports: CSV ---
function exportRecordsCSV(){
  const header = ['id','createdAt','meetingDate','ico','dic','company','contactName','phone','email','location','billingAddress','deliveryAddress','recordType','topic','notes','actionItems','nextStepDate','status','priority','geo'];
  const rows = [header];
  records.forEach(r=> rows.push(header.map(h=> r[h] ?? '')));
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'rks_zaznamy.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function exportCustomersCSV(){
  const header = ['id','ico','dic','company','address','contactName','phone','email','note'];
  const rows = [header];
  customers.forEach(c=> rows.push(header.map(h=> c[h] ?? '')));
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'rks_zakaznici.csv'; a.click(); URL.revokeObjectURL(a.href);
}
document.getElementById('exportRecords').onclick = exportRecordsCSV;
document.getElementById('exportCustomers').onclick = exportCustomersCSV;
document.getElementById('exportRecordsCSV').onclick = exportRecordsCSV;
document.getElementById('exportCustomersCSV').onclick = exportCustomersCSV;

// --- Exports: Excel-compatible XLS (XML 2003) ---
function toXLSXml(sheetName, headers, dataRows){
  function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  const cols = headers.map(()=>'<Column ss:AutoFitWidth="1"/>').join('');
  const headRow = headers.map(h=>`<Cell><Data ss:Type="String">${esc(h)}</Data></Cell>`).join('');
  const body = dataRows.map(r=>'<Row>'+ r.map(v=>`<Cell><Data ss:Type="String">${esc(v)}</Data></Cell>`).join('') +'</Row>').join('');
  return `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Worksheet ss:Name="${esc(sheetName)}">
  <Table>${cols}
   <Row>${headRow}</Row>
   ${body}
  </Table>
 </Worksheet>
</Workbook>`;
}
function downloadXLS(name, xml){
  const blob = new Blob([xml], {type:'application/vnd.ms-excel'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
}
document.getElementById('exportRecordsXLS').onclick = ()=>{
  const headers = ['id','createdAt','meetingDate','ico','dic','company','contactName','phone','email','location','billingAddress','deliveryAddress','recordType','topic','notes','actionItems','nextStepDate','status','priority','geo'];
  const rows = records.map(r=> headers.map(h=> r[h] ?? ''));
  downloadXLS('rks_zaznamy.xls', toXLSXml('Zaznamy', headers, rows));
};
document.getElementById('exportCustomersXLS').onclick = ()=>{
  const headers = ['id','ico','dic','company','address','contactName','phone','email','note'];
  const rows = customers.map(c=> headers.map(h=> c[h] ?? ''));
  downloadXLS('rks_zakaznici.xls', toXLSXml('Zakaznici', headers, rows));
};

// --- Import CSV ---
document.getElementById('importRecords').onclick = ()=>{
  const f = document.getElementById('importRecordsFile').files?.[0]; if(!f) return alert('Vyberte CSV soubor.');
  const rd = new FileReader();
  rd.onload = ()=>{
    try{
      const rows = parseCSV(rd.result);
      const headers = rows.shift().map(h=>h.trim());
      const idx = (k)=> headers.indexOf(k);
      let imported=0;
      rows.forEach(c=>{
        const r = {
          id: c[idx('id')] || uid(),
          createdAt: c[idx('createdAt')] || new Date().toISOString(),
          meetingDate: c[idx('meetingDate')] || '',
          ico: c[idx('ico')] || '',
          dic: c[idx('dic')] || '',
          company: c[idx('company')] || '',
          contactName: c[idx('contactName')] || '',
          phone: c[idx('phone')] || '',
          email: c[idx('email')] || '',
          location: c[idx('location')] || '',
          billingAddress: c[idx('billingAddress')] || '',
          deliveryAddress: c[idx('deliveryAddress')] || '',
          recordType: c[idx('recordType')] || 'Jedn√°n√≠',
          topic: c[idx('topic')] || '',
          notes: c[idx('notes')] || '',
          actionItems: c[idx('actionItems')] || '',
          nextStepDate: c[idx('nextStepDate')] || '',
          status: c[idx('status')] || 'Nov√©',
          priority: c[idx('priority')] || 'St≈ôedn√≠',
          geo: c[idx('geo')] || '',
          photo: '', signature: '', gdprConsent: true
        };
        const ex = records.findIndex(x=>x.id===r.id);
        if(ex>=0) records[ex]=r; else records.push(r);
        imported++;
      });
      save('rks_records', records);
      alert('Importov√°no z√°znam≈Ø: '+imported);
      renderList();
    }catch(e){ alert('Chyba p≈ôi importu: '+e.message); }
  };
  rd.readAsText(f, 'utf-8');
};
document.getElementById('importCustomers').onclick = ()=>{
  const f = document.getElementById('importCustomersFile').files?.[0]; if(!f) return alert('Vyberte CSV soubor.');
  const rd = new FileReader();
  rd.onload = ()=>{
    try{
      const rows = parseCSV(rd.result);
      const headers = rows.shift().map(h=>h.trim());
      const idx = (k)=> headers.indexOf(k);
      let imported=0;
      rows.forEach(c=>{
        const r = {
          id: c[idx('id')] || uid(),
          ico: c[idx('ico')] || '',
          dic: c[idx('dic')] || '',
          company: c[idx('company')] || '',
          address: c[idx('address')] || '',
          contactName: c[idx('contactName')] || '',
          phone: c[idx('phone')] || '',
          email: c[idx('email')] || '',
          note: c[idx('note')] || ''
        };
        const ex = customers.findIndex(x=>x.id===r.id || x.company.toLowerCase()===r.company.toLowerCase());
        if(ex>=0) customers[ex]=r; else customers.push(r);
        imported++;
      });
      save('rks_customers', customers);
      alert('Importov√°no z√°kazn√≠k≈Ø: '+imported);
      renderCustomers();
    }catch(e){ alert('Chyba p≈ôi importu: '+e.message); }
  };
  rd.readAsText(f, 'utf-8');
};

// --- PDF (print) ---
function printCurrent(){
  const r = getFormData();
  const win = window.open('', '_blank');
  win.document.write(`
    <html><head><title>Z√°pis z jedn√°n√≠ ‚Äì ${r.company||''}</title>
    <style>
      body{ font-family:system-ui,Segoe UI,Roboto,Arial; padding:20px; }
      h1{ margin:0 0 8px; }
      .muted{ color:#666; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 18px; }
      .box{ border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0; }
      .lbl{ font-size:12px; color:#555; }
      .val{ font-weight:600; }
      .footer{ margin-top:16px; font-size:12px; color:#666; }
      img.thumb{ max-height:100px; border:1px solid #ddd; border-radius:8px; margin-right:8px; }
      .sig{ max-height:80px; border:1px solid #ddd; border-radius:8px; background:#fff }
    </style></head><body>
    <h1>Z√°pis z jedn√°n√≠</h1>
    <div class="muted">${new Date().toLocaleString()}</div>
    <div class="grid">
      <div><div class="lbl">Spoleƒçnost</div><div class="val">${r.company||'-'}</div></div>
      <div><div class="lbl">Kontakt</div><div class="val">${r.contactName||'-'}</div></div>
      <div><div class="lbl">IƒåO / DIƒå</div><div class="val">${r.ico||'-'} / ${r.dic||'-'}</div></div>
      <div><div class="lbl">Telefon / E‚Äëmail</div><div class="val">${r.phone||'-'} / ${r.email||'-'}</div></div>
      <div><div class="lbl">M√≠sto</div><div class="val">${r.location||'-'}</div></div>
      <div><div class="lbl">Datum</div><div class="val">${fmt(r.meetingDate)}</div></div>
      <div><div class="lbl">Dodac√≠ adresa</div><div class="val">${r.deliveryAddress||'-'}</div></div>
      <div><div class="lbl">Fakturaƒçn√≠ adresa</div><div class="val">${r.billingAddress||'-'}</div></div>
      <div><div class="lbl">Typ / Priorita / Stav</div><div class="val">${r.recordType} / ${r.priority} / ${r.status}</div></div>
      <div><div class="lbl">Dal≈°√≠ krok do</div><div class="val">${r.nextStepDate? new Date(r.nextStepDate).toLocaleDateString() : '-'}</div></div>
      <div><div class="lbl">GPS</div><div class="val">${r.geo||'-'}</div></div>
    </div>
    <div class="box"><div class="lbl">T√©ma</div><div>${(r.topic||'').replace(/</g,'&lt;')}</div></div>
    <div class="box"><div class="lbl">Pozn√°mky</div><div style="white-space:pre-wrap">${(r.notes||'').replace(/</g,'&lt;')}</div></div>
    <div class="box"><div class="lbl">√ökoly / Dal≈°√≠ kroky</div><div style="white-space:pre-wrap">${(r.actionItems||'').replace(/</g,'&lt;')}</div></div>
    <div class="box">
      <div class="lbl">P≈ô√≠lohy</div>
      ${(r.photo? `<img class="thumb" src="${r.photo}">`:'')}
      ${(r.signature? `<img class="sig" src="${r.signature}">`:'')}
    </div>
    <div class="footer">
      ${brand.company} ‚Äî ${brand.address} ‚Äî ${brand.ico}<br>
      Tel: ${brand.phone} ¬∑ E‚Äëmail: ${brand.email} ¬∑ ${(brand.web||'').replace(/^https?:\/\//,'')}
    </div>
    </body></html>
  `);
  win.document.close();
  win.focus();
  win.print();
}
function printAll(){
  const headers = ['Datum','Spoleƒçnost','Kontakt','IƒåO','DIƒå','Typ','Stav','Priorita','T√©ma'];
  const rows = records.map(r=>[
    fmt(r.meetingDate||r.createdAt), r.company||'', r.contactName||'', r.ico||'', r.dic||'',
    r.recordType||'', r.status||'', r.priority||'', r.topic||''
  ]);
  const win = window.open('', '_blank');
  const rowsHtml = rows.map(r=> '<tr>'+ r.map(c=> `<td>${String(c).replace(/</g,'&lt;')}</td>`).join('') +'</tr>').join('');
  win.document.write(`
    <html><head><title>P≈ôehled z√°znam≈Ø</title>
    <style>
      body{ font-family:system-ui,Segoe UI,Roboto,Arial; padding:20px; }
      table{ width:100%; border-collapse:collapse; }
      th,td{ border:1px solid #ddd; padding:6px 8px; font-size:12px; }
      th{ background:#f3f4f6; text-align:left; }
      h1{ margin:0 0 8px; }
      .muted{ color:#666; }
    </style></head><body>
    <h1>P≈ôehled z√°znam≈Ø</h1>
    <div class="muted">${new Date().toLocaleString()}</div>
    <table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rowsHtml||'<tr><td colspan="9">≈Ω√°dn√° data</td></tr>'}</tbody></table>
    </body></html>
  `);
  win.document.close(); win.focus(); win.print();
}
document.getElementById('printBtn').onclick = printCurrent;
document.getElementById('printAll').onclick = printAll;
</script>
</body>
</html>